
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="如竹的博客">
    <title>使用动态代理实现Wifi网络下模拟3g/4g - 如竹的博客</title>
    <meta name="author" content="如竹">
    
    
        <link rel="icon" href="https://www.likebamboo.com/assets/images/favicon.ico">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="本文将介绍如果让手机在wifi网络下(不插sim卡)模拟3g/4g网络，以方便调试应用。">
<meta name="keywords" content="android,动态代理,hook">
<meta property="og:type" content="blog">
<meta property="og:title" content="使用动态代理实现Wifi网络下模拟3g&#x2F;4g">
<meta property="og:url" content="https://www.likebamboo.com/2017/08/08/android-wifi-hook/index.html">
<meta property="og:site_name" content="如竹的博客">
<meta property="og:description" content="本文将介绍如果让手机在wifi网络下(不插sim卡)模拟3g/4g网络，以方便调试应用。">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2025-10-29T12:10:40.742Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用动态代理实现Wifi网络下模拟3g&#x2F;4g">
<meta name="twitter:description" content="本文将介绍如果让手机在wifi网络下(不插sim卡)模拟3g/4g网络，以方便调试应用。">
    
    
        
    
    
        <meta property="og:image" content="https://www.likebamboo.com/assets/images/avatar.jpg"/>
    
    
        <meta property="og:image" content="https://www.likebamboo.com/2017/08/08/android-wifi-hook/grey-seal-1969506_640.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://www.likebamboo.com/2017/08/08/android-wifi-hook/grey-seal-1969506_640.jpg" />
    
    
        <meta property="og:image" content="https://www.likebamboo.com/2017/08/08/android-wifi-hook/grey-seal-1969506_640.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://www.likebamboo.com/2017/08/08/android-wifi-hook/grey-seal-1969506_640.jpg" />
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-pz4cc6y13wt2trzqa8l3n9v0yykr0sstdaheem7qj628nhjmhp9pfawvqawz.min.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-50170589-1', 'auto');
        ga('send', 'pageview');
    </script>


    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">如竹的博客</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">如竹</h4>
                
                    <h5 class="sidebar-profile-bio"><p>诗意地生活~</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="首页"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="分类"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="标签"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="归档"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="关于"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/likebamboo" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:likebamboo@163.com" target="_blank" rel="noopener" title="邮箱">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-envelope-o" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                            title="RSS"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-left
                    "
             style="background-image:url('/2017/08/08/android-wifi-hook/grey-seal-1969506_640.jpg');"
             data-behavior="4">
            
                <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            使用动态代理实现Wifi网络下模拟3g/4g
        </h1>
    
    
        <div class="post-meta">
    <time itemprop="datePublished" datetime="2017-08-08T00:00:00+08:00">
	
		    8月 08, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/android/">android</a>


    
</div>

    
</div>
            
        </div>

            <div id="main" data-behavior="4"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <!-- excerpt --></p>
<h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h3><p>最近做的需求需要频繁使用3G/4G网络，可惜公司给的测试卡流量只有几百M，播几个视频流量就耗光了，测试起来非常不方便。于是就想没有什么工具或者软件可以在wifi环境下模拟3G/4G网络，在网上找半天，结果无功而返。</p>
<p>既然没有软件能做到，那只能从代码层面下手了。代码中判断当前手机网络类型的代码比较简单：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMobileNetwork</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    ConnectivityManager cm = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">    <span class="keyword">if</span> (cm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    NetworkInfo info = cm.getActiveNetworkInfo();</span><br><span class="line">	<span class="keyword">if</span> (info == <span class="keyword">null</span> || !info.isAvailable()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ConnectivityManager.TYPE_MOBILE == info.getType();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果能让wifi环境下也返回是3G/4G网络就可以达到目的了，但是直接修改上述代码是不行的，因为判断当前是否是3G/4G网络的地方很多，一一修改比较耗时间，关键是项目中导入的很多SDK中也有网络类型的判断，SDK中的代码我们没法修改。</p>
<p>既然不能直接修改网络判断的代码，那能不能通过修改<code>ConnectivityManager</code>类（以下简称<code>CM</code>）的<code>getActiveNetworkInfo</code>方法的返回值，让wifi环境下<code>getActiveNetworkInfo</code>方法也返回3G/4G网络的<code>NetworkInfo</code>呢？</p>
<p>听起来有些似乎有点困难。让我们先看看源代码，一步一步分析。</p>
<h3 id="2-分析源码，寻找切入点"><a href="#2-分析源码，寻找切入点" class="headerlink" title="2. 分析源码，寻找切入点"></a>2. 分析源码，寻找切入点</h3><p>从源码看起来<code>CM</code>类使用了单例模式，其<code>getActiveNetworkInfo</code>方法实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> NetworkInfo <span class="title">getActiveNetworkInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mService.getActiveNetworkInfo();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中<code>mService</code>对象是<code>IConnectivityManager</code>接口（以下简称<code>ICM</code>）的一个实例，这个接口是一个aidl接口，不属于Android SDK的一部分，<a href="http://androidxref.com/5.0.0_r2/xref/frameworks/base/core/java/android/net/IConnectivityManager.aidl" target="_blank" rel="noopener">源码</a>在framework中。如果能自己创建一个<code>ICM</code>对象替换调<code>CM</code>类中原本的<code>mService</code>属性，就可以实现修改<code>getActiveNetworkInfo</code>方法返回值的效果了。</p>
<h3 id="3-使用动态代理替换原有的mService对象"><a href="#3-使用动态代理替换原有的mService对象" class="headerlink" title="3. 使用动态代理替换原有的mService对象"></a>3. 使用动态代理替换原有的<code>mService</code>对象</h3><p><code>ICM</code>对AndroidSDK不可见，我们不能直接创建一个类并实现了<code>ICM</code>接口。另外这个接口声明了50个左右的方法，即使能创建实现了<code>ICM</code>接口的实例，要重写这50个左右的方法也不那么容易。那有没有其他简便的方法创建<code>ICM</code>实例呢？有，使用动态代理。</p>
<p>关于什么是动态代理，动态代理可以做什么，可以参考<a href="http://weishu.me/2016/01/28/understand-plugin-framework-proxy-hook/" target="_blank" rel="noopener">这篇文章</a>，这里不再介绍（其实是技术太菜，说不清楚）。下面是使用动态代理替换<code>CM</code>中原有的<code>mService</code>属性的过程：</p>
<ol>
<li><p>使用反射获取原有的<code>mService</code>对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先获取ConnectivityManager对象</span></span><br><span class="line">ConnectivityManager cm = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line"><span class="comment">// 获取ConnectivityManager的mService对象</span></span><br><span class="line">Field[] fs = ConnectivityManager<span class="class">.<span class="keyword">class</span>.<span class="title">getDeclaredFields</span>()</span>;</span><br><span class="line">Object mService = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (fs != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Field f : fs) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"mService"</span>.equals(f.getName())) &#123;</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            mService = f.get(cm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用动态代理创建<code>ICM</code>对象，并修改 <code>getActiveNetworkInfo</code> 的返回值为自己准备好的<code>networkInfo</code>，其他方法仍然调用<code>mService</code>的相应方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Object mFinalService = mService;</span><br><span class="line"><span class="comment">// 使用动态代理创建 IConnectivityManager 的实例</span></span><br><span class="line">Object mProxyService = Proxy.newProxyInstance(ConnectivityManager<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>(),</span></span><br><span class="line"><span class="class">    // 需要实现的接口</span></span><br><span class="line">    new Class[]&#123;Class.forName("android.net.IConnectivityManager")&#125;,</span><br><span class="line">    <span class="comment">// 方法调用处理器</span></span><br><span class="line">    <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="comment">// 拦截 getActiveNetworkInfo, 返回自己准备好的networkInfo</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"getActiveNetworkInfo"</span>.equals(method.getName())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (SettingsPreferences.getHookNetwork(context)) &#123;</span><br><span class="line">                    <span class="comment">// 该networkInfo是自己手动创建的3g模式的NetworkInfo。</span></span><br><span class="line">                    <span class="keyword">return</span> networkInfo;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 不拦截其他方法，</span></span><br><span class="line">            <span class="keyword">return</span> method.invoke(mFinalService, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>将原来的<code>mService</code>对象替换为上一步中创建的<code>mProxyService</code>对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将自己创建的代理对象`mProxyService`替换调原来的`mService`对象。</span></span><br><span class="line"><span class="keyword">if</span> (fs != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Field f : fs) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"mService"</span>.equals(f.getName())) &#123;</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            f.set(cm, mProxyService);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这样就完成了修改<code>getActiveNetworkInfo</code>方法的返回值的目标，同时还能控制什么情况下返回自己定义的<code>NetworkInfo</code> (上述代码中只有当<code>SettingsPreferences.getHookNetwork(context)</code>为true的情况下才返回自己创建的networkInfo，否则仍然返回系统原本的networkInfo)。</p>
<blockquote>
<p>通过上述方式是不是能做到让代码中所有调用<code>getActiveNetworkInfo</code>方法的地方都返回自己创建的<code>NetworkInfo</code>呢？</p>
</blockquote>
<p>实践中发现：<code>CM</code>类看起来使用了单例模式，但事实上，在Api level 19 及以上的系统使用不同的<code>context</code>调用<code>getSystemService</code>方法返回的是不同的<code>CM</code>对象。</p>
<p>也就是说在代码中调用 <code>getSystemService</code>方法时用的<code>context</code>和上述代码中<code>context</code>不一样，那么获取到的<code>NetworkInfo</code>对象仍然可能是系统本身的<code>NetworkInfo</code>而不是我们自己创建的<code>NetworkInfo</code>。</p>
<h3 id="4-替换IConnectivityManager对象的创建过程"><a href="#4-替换IConnectivityManager对象的创建过程" class="headerlink" title="4. 替换IConnectivityManager对象的创建过程"></a>4. 替换<code>IConnectivityManager</code>对象的创建过程</h3><p>既然直接替换<code>mService</code>属性不完全可行，那能不能尝试找到<code>mService</code>被创建的地方，然后替换掉<code>mService</code>的创建过程，让所有给<code>mService</code>赋值的地方都返回我们自己创建的<code>ICM</code>对象呢？</p>
<blockquote>
<p>这个过程就好比现在小区内有好几家超市都在卖矿泉水，你想让这些超市都卖你自己生产的矿泉水，现在通过动态代理的方式你可以做到让其中一家超市卖你生产的矿泉水了。接下来你想让所有超市都卖你生产的矿泉水，如果能找到这些超市在哪家供应商进的货，然后通过某种方式，把供应商的货都替换为你生产的矿泉水那就ok了。</p>
</blockquote>
<p>来看看<code>mService</code>是何时以及怎么被创建的。</p>
<p>首先，<code>CM</code>是通过<code>Context</code>对象的<code>getSystemService</code>方法获取的。我们看看<code>getSystemService</code>方法是怎么实现的(<code>Context</code>的实现在<code>ContextImpl</code>里面)：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSystemService</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</span><br><span class="line">    <span class="keyword">return</span> fetcher != <span class="keyword">null</span> ? fetcher.getService(ctx) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面的代码可以看出来，所有的service对象都保存在一张map(<code>SYSTEM_SERVICE_FETCHERS</code>)中，该map的初始化过程如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">registerService(Context.CONNECTIVITY_SERVICE, ConnectivityManager<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">new</span> <span class="title">StaticApplicationContextServiceFetcher</span>&lt;<span class="title">ConnectivityManager</span>&gt;() </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ConnectivityManager <span class="title">createService</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">            IBinder b = ServiceManager.getService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">            IConnectivityManager service = IConnectivityManager.Stub.asInterface(b);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ConnectivityManager(context, service);</span><br><span class="line">        &#125;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>从上述代码看来，<code>ICM</code>的创建依赖于<code>ServiceManager.getService</code>方法返回的<code>IBinder</code>对象，使用这个<code>IBinder</code>对象再调用<code>IConnectivityManager.Stub</code>类的静态方法<code>asInterface</code>就可以将其转为本地接口<code>ICM</code>对象（这也使用<code>Binder</code>进行跨进程方法调用的基本流程）:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> android.net.<span class="function">IConnectivityManager <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">    <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> android.net.IConnectivityManager))) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((android.net.IConnectivityManager) iin);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> android.net.IConnectivityManager.Stub.Proxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>总结一下： <code>CM</code>的<code>getActiveNetworkInfo</code>方法直接调用了其成员变量<code>mService</code>的<code>getActiveNetworkInfo</code>方法，而<code>mService</code>是一个<code>ICM</code>的实例，它是在<code>CM</code>对象创建时被赋值的(构造函数中)。<code>CM</code>对象的创建位于<code>ContextImpl</code>类中，其创建时会首先调用<code>ServiceManager.getService</code>方法获取到一个<code>IBinder</code>对象，并通过<code>IConnectivityManager.Stub</code>的静态方法<code>asInterface</code>将这个<code>IBinder</code>对象转为<code>ICM</code>对象，最终以这个<code>ICM</code>对象作为参数创建了<code>CM</code>对象。</p>
</blockquote>
<p>找到<code>CM</code>以及<code>ICM</code>创建的地方后，目标就很明确了：只要自己创建一个<code>IBinder</code>对象替换掉<code>ServiceManager.getService</code>方法返回的<code>IBinder</code>对象，然后修改这个<code>IBinder</code>的<code>queryLocalInterface</code>方法让它始终返回同一个<code>ICM</code>对象就可以了。</p>
<p>要想替换掉<code>ServiceManager.getService</code>的返回值，我们先看看这个方法的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title">getService</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        IBinder service = sCache.get(name);</span><br><span class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> service;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getIServiceManager().getService(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"error in getService"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码中， <code>sCache</code>是<code>ServiceManager</code>的一个静态成员变量（<code>Map</code>类型），我们可以自己创建一个<code>IBinder</code>对象（跟之前一样，使用动态代理创建），然后通过<code>Map</code>的<code>put</code>方法将<code>sCache</code>里面的内容替换，从而达到瞒天过海的目的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先获取ServiceManager class</span></span><br><span class="line">Class&lt;?&gt; serviceManager = Class.forName(<span class="string">"android.os.ServiceManager"</span>);</span><br><span class="line">Method getService = serviceManager.getDeclaredMethod(<span class="string">"getService"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">// 调用ServiceManag的"getService"方法获取原始的 IBinder 对象</span></span><br><span class="line"><span class="keyword">final</span> IBinder rawBinder = (IBinder) getService.invoke(<span class="keyword">null</span>, Context.CONNECTIVITY_SERVICE);</span><br><span class="line"><span class="comment">// 使用动态代理伪造一个新的 IBinder对象</span></span><br><span class="line">IBinder hookedBinder = (IBinder) newProxyInstance(serviceManager.getClassLoader(),</span><br><span class="line">        <span class="keyword">new</span> Class&lt;?&gt;[] &#123;IBinder<span class="class">.<span class="keyword">class</span>&#125;, <span class="title">new</span> <span class="title">InvocationHandler</span>()</span></span><br><span class="line"><span class="class">        </span>&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="comment">// ....</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">// 把伪造的 IBinder 对象放进ServiceManager的cache里面</span></span><br><span class="line">Field cacheField = serviceManager.getDeclaredField(<span class="string">"sCache"</span>);</span><br><span class="line">cacheField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">Map&lt;String, IBinder&gt; cache = (Map&lt;String, IBinder&gt;) cacheField.get(<span class="keyword">null</span>);</span><br><span class="line">cache.put(Context.CONNECTIVITY_SERVICE, hookedBinder);</span><br></pre></td></tr></table></figure></p>
<p>替换掉<code>ServiceManager.getService</code>的返回值以后，接着我们需要修改我们刚刚创建的<code>IBinder</code>对象的<code>queryLocalInterface</code>方法，让它始终返回同一个<code>ICM</code>对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">    <span class="keyword">private</span> Object mIConnectivityManager = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取原本的IConnectivityManager对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">getBaseManager</span><span class="params">(@NonNull IBinder binder, Class&lt;?&gt; stubCls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method asInterfaceMethod = stubCls.getDeclaredMethod(<span class="string">"asInterface"</span>, IBinder<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">return</span> asInterfaceMethod.invoke(<span class="keyword">null</span>, binder);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtils.error(<span class="string">"wentaoli hook =&gt; createIConnectivityManager error: "</span> + e, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">"queryLocalInterface"</span>.equals(method.getName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(baseBinder, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mIConnectivityManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mIConnectivityManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换掉 queryLocalInterface 方法的返回值</span></span><br><span class="line">        Object base = getBaseManager(baseBinder, Class.forName(<span class="string">"android.net.IConnectivityManager$Stub"</span>));</span><br><span class="line">        mIConnectivityManager = Proxy.newProxyInstance(proxy.getClass().getClassLoader(),</span><br><span class="line">                <span class="comment">// asInterface 的时候会检测是否是特定类型的接口然后进行强制转换, 因此这里的动态代理生成的类型信息的类型必须是正确的</span></span><br><span class="line">                new Class[]&#123;IInterface.class, Class.forName("android.net.IConnectivityManager")&#125;,</span><br><span class="line">                <span class="keyword">new</span> BinderHookHandler(context, base));</span><br><span class="line">        <span class="keyword">return</span> mIConnectivityManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderHookHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    Context context;</span><br><span class="line">    <span class="comment">// 原始的IConnectivityManager对象 (也是IInterface)</span></span><br><span class="line">    Object base;</span><br><span class="line">    BinderHookHandler(Context context, Object base) &#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context.getApplicationContext();</span><br><span class="line">        <span class="keyword">this</span>.base = base;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"getActiveNetworkInfo"</span>.equals(method.getName())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (SettingsPreferences.getHookNetwork(context)) &#123;</span><br><span class="line">                <span class="keyword">return</span> networkInfo;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(base, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大功告成。</p>
<h3 id="5-模拟发送网络变化广播"><a href="#5-模拟发送网络变化广播" class="headerlink" title="5. 模拟发送网络变化广播"></a>5. 模拟发送网络变化广播</h3><p>经过上面操作，已经可以做到在wifi环境下模拟移动网络了，但还有一些可以完善的地方，比如说网络的切换。</p>
<p>考虑如下情况：当在应用中通过手动点击某个按钮将上述<code>SettingsPreferences.getHookNetwork(context)</code>的值从<code>false</code>变为<code>true</code>，这时候<code>getActiveNetworkInfo</code>方法返回的<code>NetworkInfo</code>就从原来的wifi变成了自定义的3g/4g网络，这事实上就相当于发生了一次网络状态的变化。按照正常的流程，如果手机发生网络状态变化系统会发送相应的广播，同时app中动态或者静态注册的广播接收器会收到相应的广播。但是现在我们只是模拟网络变化，系统自然不会帮忙发送网络状态变化广播，那怎么去模拟这个过程呢？</p>
<p>网络状态变化广播是一个敏感的广播，需要系统级权限才能发送，普通应用是不允许发送的。既然不能直接发送这个广播，那能不能通过获取到当前应用中所注册的广播接收器，然后直接调用这些广播接收器的<code>onReceive</code>方法来模拟广播接收过程呢？让我们来分析下。</p>
<p>首先来看静态注册的广播接收器。</p>
<h4 id="5-1-静态注册的广播接收器"><a href="#5-1-静态注册的广播接收器" class="headerlink" title="5.1.  静态注册的广播接收器"></a>5.1.  静态注册的广播接收器</h4><p>要获取当前app中的注册了哪些静态广播接收器是比较简单的，就跟获取app中声明了哪些<code>Activity</code>是一样的逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent i = <span class="keyword">new</span> Intent(ConnectivityManager.CONNECTIVITY_ACTION);</span><br><span class="line">i.setPackage(context.getPackageName());</span><br><span class="line">List&lt;ResolveInfo&gt; list = context.getPackageManager().queryBroadcastReceivers(i, PackageManager.MATCH_ALL);</span><br></pre></td></tr></table></figure></p>
<p>通过上述代码拿到能接收网络状态变化的静态广播接收器后（当然并不是<code>BroadcastReceiver</code>实例对象，仅仅是一些<code>BroadcastReceiver</code>描述信息），只需遍历这些接收器信息，然后通过<code>Class.newInstance</code>方法创建相应的<code>BroadcastReceiver</code>实例，再调用其<code>onReceive</code>方法就行了，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ResolveInfo resolveInfo : list) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(resolveInfo.activityInfo.name);</span><br><span class="line">        BroadcastReceiver receiver = (BroadcastReceiver) clazz.newInstance();</span><br><span class="line">        receiver.onReceive(context, intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LogUtils.error(<span class="string">"wentaoli hook static receiver error "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样就完成了模拟静态注册的广播接收器收到广播的场景。</p>
<p>下面再看动态注册的广播接收器</p>
<h4 id="5-2-动态注册的广播接收器"><a href="#5-2-动态注册的广播接收器" class="headerlink" title="5.2.  动态注册的广播接收器"></a>5.2.  动态注册的广播接收器</h4><p>要获得应用中所有动态注册的广播接收器并不容易。通过对广播注册与接收的源代码的分析得知(关于广播的注册接收过程可以参考<a href="http://weishu.me/2016/04/12/understand-plugin-framework-receiver/" target="_blank" rel="noopener">这篇博客</a>)，广播的接收过程最终会走到<code>LoadedApk</code>的一个内部类 <code>ReceiverDispatcher</code>的<code>performReceive</code>方法中，而<code>LoadedApk</code>的一个成员变量<code>mReceivers</code>则保存了当前app中所有动态注册的广播接收器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;Context, HashMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;&gt; mReceivers = <span class="keyword">new</span> HashMap&lt;Context, HashMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;&gt;();</span><br></pre></td></tr></table></figure></p>
<p>只要能拿到<code>LoadedApk</code>实例的<code>mReceviers</code>属性值，则可以获取到所有动态注册的广播。要获取<code>LoadedApk</code>的<code>mReceivers</code>属性值，首先得拿到<code>LoadedApk</code>的实例。事实上，<code>ActivityThread</code> 的<code>mPackages</code>属性就持有<code>LoadedApk</code>的实例(看过四大组件启动流程源代码的同学应该对<code>ActivityThread</code>类很熟悉)，接着获取<code>LoadedApk</code>以及<code>LoadedApk</code>的<code>mReceivers</code>属性就都不是问题了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先获取到当前应用的ActivityThread对象</span></span><br><span class="line">Class&lt;?&gt; activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">Method currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">currentActivityThreadMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Object currentActivityThread = currentActivityThreadMethod.invoke(<span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// 获取mPackages属性</span></span><br><span class="line">Field f = activityThreadClass.getDeclaredField(<span class="string">"mPackages"</span>);</span><br><span class="line">f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Map map = (Map) f.get(currentActivityThread);</span><br><span class="line"><span class="comment">// 获取LoadedApk实例</span></span><br><span class="line">Object loadedApkRef = map.get(context.getPackageName());</span><br><span class="line"><span class="keyword">if</span> (loadedApkRef <span class="keyword">instanceof</span> WeakReference) &#123;</span><br><span class="line">     Object loadedApk = ((WeakReference) loadedApkRef).get();</span><br><span class="line">     <span class="comment">// 获取LoadedApk实例的mReceivers属性值</span></span><br><span class="line">     field = loadedApk.getClass().getDeclaredField(<span class="string">"mReceivers"</span>);</span><br><span class="line">     field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">     Map mReceiversMap = (Map) field.get(loadedApk);</span><br><span class="line">     <span class="comment">// 通过mReceivers属性获取所有动态注册的广播</span></span><br><span class="line">     ....</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>在获取到所有动态注册的广播接收器后，只要知道哪些广播接收器可以接收网络状态变化广播，然后再直接调用这些广播接收器的<code>onReceive</code>方法就好了。但事实上这并不容易，具体怎么判断哪些广播接收器可以接收网络状态变化广播，就不再说明了（其实是懒），有兴趣的可以到<a href="https://gist.github.com/likebamboo/83b51fa9446c9ac04131c5798094973e" target="_blank" rel="noopener">这里</a>查看代码。</p>
<p>到此为止就完成了对发送网络状态变化广播的模拟，也就完成了Wifi下模拟3g/4g网络的整个流程的模拟。</p>
<h3 id="6-其他"><a href="#6-其他" class="headerlink" title="6. 其他"></a>6. 其他</h3><ol>
<li><p>关于动态代理：<br>动态代理是<code>AOP</code>的基础。像 <a href="https://github.com/DroidPluginTeam/DroidPlugin" target="_blank" rel="noopener">DroidPlugin</a> 之类插件框架以动态代理作为基础的。</p>
</li>
<li><p>关于兼容性：<br>文中的代码中使用了较多的反射调用以及系统隐藏的api，由于公司没有那么多手机，没有测试代码的兼容性。</p>
</li>
</ol>
<h3 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h3><blockquote>
<p><a href="http://weishu.me/2016/04/12/understand-plugin-framework-receiver/" target="_blank" rel="noopener">http://weishu.me/2016/04/12/understand-plugin-framework-receiver/</a><br><a href="http://weishu.me/2016/01/28/understand-plugin-framework-proxy-hook/" target="_blank" rel="noopener">http://weishu.me/2016/01/28/understand-plugin-framework-proxy-hook/</a><br><a href="http://blog.csdn.net/u013263323/article/details/76014494" target="_blank" rel="noopener">http://blog.csdn.net/u013263323/article/details/76014494</a><br><a href="http://blog.csdn.net/Luoshengyang/article/details/6744448" target="_blank" rel="noopener">http://blog.csdn.net/Luoshengyang/article/details/6744448</a></p>
</blockquote>
            

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/android/">android</a> <a class="tag tag--primary tag--small t-link" href="/tags/hook/">hook</a> <a class="tag tag--primary tag--small t-link" href="/tags/动态代理/">动态代理</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/03/01/gradle-plugin/" data-tooltip="Gradle插件开发基础" aria-label="上一篇: Gradle插件开发基础">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/05/22/android-theme-switch/" data-tooltip="Android 主题切换实现方案探索" aria-label="下一篇: Android 主题切换实现方案探索">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://service.weibo.com/share/share.php?&amp;title=https://www.likebamboo.com/2017/08/08/android-wifi-hook/" title="分享到 Weibo">
                    <i class="fa fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://connect.qq.com/widget/shareqq/index.html?url=https://www.likebamboo.com/2017/08/08/android-wifi-hook/&amp;title=使用动态代理实现Wifi网络下模拟3g/4g" title="分享到 QQ">
                    <i class="fa fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.likebamboo.com/2017/08/08/android-wifi-hook/" title="分享到 Qzone">
                    <i class="fa fa-star" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="gitalk-container"></div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 如竹. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/03/01/gradle-plugin/" data-tooltip="Gradle插件开发基础" aria-label="上一篇: Gradle插件开发基础">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/05/22/android-theme-switch/" data-tooltip="Android 主题切换实现方案探索" aria-label="下一篇: Android 主题切换实现方案探索">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://service.weibo.com/share/share.php?&amp;title=https://www.likebamboo.com/2017/08/08/android-wifi-hook/" title="分享到 Weibo">
                    <i class="fa fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://connect.qq.com/widget/shareqq/index.html?url=https://www.likebamboo.com/2017/08/08/android-wifi-hook/&amp;title=使用动态代理实现Wifi网络下模拟3g/4g" title="分享到 QQ">
                    <i class="fa fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.likebamboo.com/2017/08/08/android-wifi-hook/" title="分享到 Qzone">
                    <i class="fa fa-star" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <i id="btn-close-shareoptions" class="fa fa-close"></i>
    <ul class="share-options">
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://service.weibo.com/share/share.php?&amp;title=https://www.likebamboo.com/2017/08/08/android-wifi-hook/">
                    <i class="fa fa-weibo" aria-hidden="true"></i><span>分享到 Weibo</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://connect.qq.com/widget/shareqq/index.html?url=https://www.likebamboo.com/2017/08/08/android-wifi-hook/&amp;title=使用动态代理实现Wifi网络下模拟3g/4g">
                    <i class="fa fa-qq" aria-hidden="true"></i><span>分享到 QQ</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.likebamboo.com/2017/08/08/android-wifi-hook/">
                    <i class="fa fa-star" aria-hidden="true"></i><span>分享到 Qzone</span>
                </a>
            </li>
        
    </ul>
</div>

            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
        
            <h4 id="about-card-name">如竹</h4>
        
            <div id="about-card-bio"><p>诗意地生活~</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p><a href='https://srf.baidu.com' target='_blank'>百度手机输入法</a></p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                ShenZhen
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-peofhqjkzcghmndknakluequy1y6owxdwpaqyju9ntl9zxnk7rdolb3rjjoj.min.js"></script>
<!--SCRIPTS END-->

    
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
		<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
		<script type="text/javascript">
			var gitalk = new Gitalk({
				  clientID: 'b6336850403ce274da24',
				  clientSecret: 'f665e0808a622fb04c3e57b8bc8d2079347c5c7b',
				  repo: 'likebamboo.github.com',
				  owner: 'likebamboo',
				  admin: 'likebamboo',
				  id: '2017/08/08/android-wifi-hook/', // Ensure uniqueness and length less than 50{{ page.title }}
				  distractionFreeMode: 'true'  // Facebook-like distraction free mode
				})
				gitalk.render('gitalk-container')
		</script>
    



    </body>
</html>
